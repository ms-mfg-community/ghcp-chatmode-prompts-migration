---
mode: agent
model: Claude Sonnet 3.7
tools: ['codebase', 'usages', 'vscodeAPI', 'think', 'problems', 'changes', 'testFailure', 'terminalSelection', 'terminalLastCommand', 'openSimpleBrowser', 'fetch', 'findTestFiles', 'searchResults', 'githubRepo', 'extensions', 'runTests', 'editFiles', 'runNotebooks', 'search', 'new', 'runCommands', 'runTasks', 'Microsoft Docs', 'Azure MCP']
---
Deploy application to Azure, using Azure Developer CLI (azd) for streamlined deployment. 

# Rules for deployment using user's desktop

- Use files generated by the previous steps in the 'reports' folder as references for deployment.
- Guide the user using the 'runCommands' to deploy using Azure Developer CLI (azd).
At the end, generate a comprehensive deployment summary report in the reports folder, including:
- Deployment timeline and status
- Resource configurations and endpoints
- Security and monitoring setup
- Performance baseline measurements
- Operational procedures and troubleshooting guides
- Cost analysis and optimization recommendations
- Next steps for ongoing maintenance and optimization

- Suggest that the next step is to set up CI/CD pipelines, and mention `/phase6-setupcicd` is the command to start the CI/CD setup process.
- At the end, update the status report file reports/Report-Status.md with the status of the deployment step.

## Pre-Deployment Checklist

Before deploying, ensure:
- You have the latest Azure CLI and Azure Developer CLI installed
- You are logged in to Azure (`az login`)
- You have selected the correct subscription (`az account set --subscription <subscription-id>`)
- Your infrastructure files in the `infra/` folder are correctly set up and validated
- Your application code is ready for deployment
- If containerization is required, ensure Docker is installed and running

## Deployment Process Based on Target Platform

### For Azure App Service Deployments:
- Configure deployment settings in azure.yaml
- Set up application settings and connection strings
- Configure continuous deployment if needed
- Set up custom domains and SSL certificates if applicable
- Configure scaling rules
- Set up monitoring with Application Insights

### For Azure Kubernetes Service (AKS) Deployments:
- Ensure container images are built and pushed to a container registry
- Configure Kubernetes manifests or Helm charts
- Set up ingress controllers if needed
- Configure horizontal pod autoscalers
- Set up monitoring with Azure Monitor for Containers
- Configure network policies and security settings

### For Azure Container Apps Deployments:
- Ensure container images are built and pushed to a container registry
- Configure container app settings in the infrastructure files
- Set up scaling rules and triggers
- Configure ingress settings if needed
- Set up monitoring with Application Insights
- Configure environment variables and secrets

## Deployment Steps

1. **Environment Setup**
   ```bash
   # Initialize azd environment
   azd init

   # or use an existing environment
   azd env select <environment-name>
   ```

2. **Deploy the Application**
   ```bash
   # Deploy with azd
   azd up
   
   # Or provision infrastructure separately
   azd provision
   
   # Then deploy code
   azd deploy
   ```

3. **Verify Deployment**
   Use `azure_get_azd_app_logs` to check application logs and health status:
   - Verify all resources were created successfully in Azure portal
   - Check application logs for any errors or warnings
   - Test application functionality including authentication flows
   - Verify monitoring is working properly with Application Insights
   - Check that authentication with Entra ID is working correctly
   - Validate database connections and data access
   - Test API endpoints and verify proper responses
   - Check scaling and performance under load
   - Verify security configurations are properly applied

## Post-Deployment Tasks

- Use `azure_applens-diagnose_resource` to perform health checks on deployed resources
- Configure any additional settings in the Azure portal
- Set up CI/CD pipelines using `azure_config_deploymentpipeline` for future deployments
- Configure monitoring alerts and notification channels
- Set up backup and disaster recovery policies
- Validate security configurations and run security scans
- Perform load testing to validate performance
- Document the deployment process and configuration
- Create runbooks for operational procedures
- Set up cost monitoring and optimization alerts

## Error Handling and Troubleshooting

- If deployment fails, use `azure_activity_log-list` to investigate issues
- Use `azure_applens-diagnose_resource` to get insights into resource problems
- Check `azure_get_azd_app_logs` for application-specific errors
- Validate that all prerequisites are met (quotas, permissions, etc.)
- Verify that infrastructure files pass all validation checks
- Check for regional service outages or capacity issues
